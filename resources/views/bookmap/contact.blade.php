<style type="text/css">
 

  #contact a {
    text-decoration: none !important;
  }
		
  #contact label {
    color: rgba(120, 144, 156,1.0) !important;
  }
		
	#contact .btn:focus, .btn:active:focus, .btn.active:focus {
			outline: none !important;
			box-shadow: 0 0px 0px rgba(120, 144, 156,1.0) inset, 0 0 0px rgba(120, 144, 156,0.8);
  }

  #contact textarea:focus,
		input[type="text"]:focus,
		input[type="password"]:focus,
		input[type="datetime"]:focus,
		input[type="datetime-local"]:focus,
		input[type="date"]:focus,
		input[type="month"]:focus,
		input[type="time"]:focus,
		input[type="week"]:focus,
		input[type="number"]:focus,
		input[type="email"]:focus,
		input[type="url"]:focus,
		input[type="search"]:focus,
		input[type="tel"]:focus,
		input[type="color"]:focus,
		.uneditable-input:focus {   
		border-color: rgba(120, 144, 156,1.0); color: rgba(120, 144, 156,1.0); opacity: 0.9;
		box-shadow: 0 0px 0px rgba(120, 144, 156,1.0) inset, 0 0 10px rgba(120, 144, 156,0.3);
		outline: 0 none;
  }

  #contact.card::-webkit-scrollbar {
    width: 1px;
  }
 
  #contact::-webkit-scrollbar-thumb {
    border-radius: 9px;
	  background: rgba(96, 125, 139,0.99);
  }

  #contact .balon1, .balon2 {
	  margin-top: 5px !important;
	  margin-bottom: 5px !important;
	}

  #contact .balon1 a {
    background: #42a5f5;
    color: #fff !important;
    border-radius: 20px 20px 3px 20px;
    display: block;
    max-width: 75%;
    padding: 7px 13px 7px 13px;
	}

  #contact .balon1:before {
    content: attr(data-is);
    position: absolute;
    right: 15px;
    bottom: -0.8em;
    display: block;
    font-size: .750rem;
    color: rgba(84, 110, 122,1.0);
	}

  #contact .balon2 a {
    background: #f1f1f1;
    color: #000 !important;
    border-radius: 20px 20px 20px 3px;
    display: block;
    max-width: 75%;
    padding: 7px 13px 7px 13px;
	}
	
  #contact .balon2:before {
    content: attr(data-is);
    position: absolute;
    left: 13px;
    bottom: -0.8em;
    display: block;
    font-size: .750rem;
    color: rgba(84, 110, 122,1.0);
	}
	
  #contact .bg-sohbet:before {
    content: "";
    background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTAgOCkiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+PGNpcmNsZSBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIgY3g9IjE3NiIgY3k9IjEyIiByPSI0Ii8+PHBhdGggZD0iTTIwLjUuNWwyMyAxMW0tMjkgODRsLTMuNzkgMTAuMzc3TTI3LjAzNyAxMzEuNGw1Ljg5OCAyLjIwMy0zLjQ2IDUuOTQ3IDYuMDcyIDIuMzkyLTMuOTMzIDUuNzU4bTEyOC43MzMgMzUuMzdsLjY5My05LjMxNiAxMC4yOTIuMDUyLjQxNi05LjIyMiA5LjI3NC4zMzJNLjUgNDguNXM2LjEzMSA2LjQxMyA2Ljg0NyAxNC44MDVjLjcxNSA4LjM5My0yLjUyIDE0LjgwNi0yLjUyIDE0LjgwNk0xMjQuNTU1IDkwcy03LjQ0NCAwLTEzLjY3IDYuMTkyYy02LjIyNyA2LjE5Mi00LjgzOCAxMi4wMTItNC44MzggMTIuMDEybTIuMjQgNjguNjI2cy00LjAyNi05LjAyNS0xOC4xNDUtOS4wMjUtMTguMTQ1IDUuNy0xOC4xNDUgNS43IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PHBhdGggZD0iTTg1LjcxNiAzNi4xNDZsNS4yNDMtOS41MjFoMTEuMDkzbDUuNDE2IDkuNTIxLTUuNDEgOS4xODVIOTAuOTUzbC01LjIzNy05LjE4NXptNjMuOTA5IDE1LjQ3OWgxMC43NXYxMC43NWgtMTAuNzV6IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIvPjxjaXJjbGUgZmlsbD0iIzAwMCIgY3g9IjcxLjUiIGN5PSI3LjUiIHI9IjEuNSIvPjxjaXJjbGUgZmlsbD0iIzAwMCIgY3g9IjE3MC41IiBjeT0iOTUuNSIgcj0iMS41Ii8+PGNpcmNsZSBmaWxsPSIjMDAwIiBjeD0iODEuNSIgY3k9IjEzNC41IiByPSIxLjUiLz48Y2lyY2xlIGZpbGw9IiMwMDAiIGN4PSIxMy41IiBjeT0iMjMuNSIgcj0iMS41Ii8+PHBhdGggZmlsbD0iIzAwMCIgZD0iTTkzIDcxaDN2M2gtM3ptMzMgODRoM3YzaC0zem0tODUgMThoM3YzaC0zeiIvPjxwYXRoIGQ9Ik0zOS4zODQgNTEuMTIybDUuNzU4LTQuNDU0IDYuNDUzIDQuMjA1LTIuMjk0IDcuMzYzaC03Ljc5bC0yLjEyNy03LjExNHpNMTMwLjE5NSA0LjAzbDEzLjgzIDUuMDYyLTEwLjA5IDcuMDQ4LTMuNzQtMTIuMTF6bS04MyA5NWwxNC44MyA1LjQyOS0xMC44MiA3LjU1Ny00LjAxLTEyLjk4N3pNNS4yMTMgMTYxLjQ5NWwxMS4zMjggMjAuODk3TDIuMjY1IDE4MGwyLjk0OC0xOC41MDV6IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIvPjxwYXRoIGQ9Ik0xNDkuMDUgMTI3LjQ2OHMtLjUxIDIuMTgzLjk5NSAzLjM2NmMxLjU2IDEuMjI2IDguNjQyLTEuODk1IDMuOTY3LTcuNzg1LTIuMzY3LTIuNDc3LTYuNS0zLjIyNi05LjMzIDAtNS4yMDggNS45MzYgMCAxNy41MSAxMS42MSAxMy43MyAxMi40NTgtNi4yNTcgNS42MzMtMjEuNjU2LTUuMDczLTIyLjY1NC02LjYwMi0uNjA2LTE0LjA0MyAxLjc1Ni0xNi4xNTcgMTAuMjY4LTEuNzE4IDYuOTIgMS41ODQgMTcuMzg3IDEyLjQ1IDIwLjQ3NiAxMC44NjYgMy4wOSAxOS4zMzEtNC4zMSAxOS4zMzEtNC4zMSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEuMjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvZz48L3N2Zz4=');
    opacity: 0.06;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    height:100%;
    position: absolute;   
	}

</style>

<div id="contact_container" class="tab-content col-md-12 p-0" style="flex: 1; position: absolute; right: 0; bottom: 0; left: 0;">  
  <div class="row h-100 m-0 p-0">
    <div class="col-3 p-0 m-0 card border-0 rounded" style="box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.10), 0 6px 10px 0 rgba(0, 0, 0, 0.01); overflow: hidden;">
      <div class="card-header p-1 bg-light border border-top-0 border-left-0 border-right-0" style="color: rgba(96, 125, 139,1.0);">
        <form class="m-0 p-0" action="" method="POST" autocomplete="off">
          <div class="row m-0 p-0">
            <div class="col-12 m-0 p-1">
              <input id="text" class="mw-100 border rounded form-control" type="text" name="text" title="Type a message..." placeholder="Type a message..." required>
            </div>
          </div>
        </form>
      </div>
      <div class="card card-body border-0 m-0 p-0" style="overflow-y: auto; height: 0;" id="append_user_chat">
      </div>
    </div>
    <div class="col-9 p-0 m-0 card border-0 rounded" style="box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.10), 0 6px 10px 0 rgba(0, 0, 0, 0.01); overflow: hidden;"> 
      <div class="card-header p-1 bg-light border border-top-0 border-left-0 border-right-0 d-none" style="color: rgba(96, 125, 139,1.0);" id="header_user_chat">
      </div>
      <div class="card card-body bg-sohbet border-0 m-0 p-0" style="overflow-y: auto; height: 0;" id="append_chat">
      </div>
      <div class="w-100 card-footer p-0 bg-light border border-bottom-0 border-left-0 border-right-0 d-none" id="footer_user_chat">
        <div class="m-0 p-0">
          <div class="row m-0 p-0">
            <div class="col-10 m-0 p-1">
              <input type="text" class="mw-100 border rounded form-control chatSend" from="contact" id="send_chat_message_from_input" type="text" name="text" title="Type a message..." placeholder="Type a message..." required>
            </div>
            <div class="col-2 m-0 p-1">
              <button class="btn btn-outline-secondary rounded border w-100" id="send_chat_message_from_button" style="padding-right: 16px;"><i class="bx bx-send icon-single" aria-hidden="true"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">

  function start_function_contact(){
    get_user_bookmap();
  }

  //1)mostro gli utenti con i quali ci sono state conversazioni
  function get_user_bookmap(){
    $.get('/get_user_chat_box_bookmap', {}, 
      function (data){
        $("#append_user_chat").empty();
        var res=jQuery.parseJSON(data);
        $.each(res, function(key, value) {
          var div=
          $("<div>")
            .attr("id_room",value["id_room"])
            .addClass("d-flex flex-nowrap border-0 pt-3 px-3 open_chat")
            .append(
              $("<img>")
                .addClass("rounded")
                .css({"width": "50px","height": "50px"})
                .attr("src","bookmap_repo/img_profile/"+value["image"])
            )
            .append(
              $("<h6>")
                .css({"margin": "0px", "margin-left": "10px"})
                .text(value["username"])
            )
            .append(
              $("<span>")
                .addClass("ml-2 badge badge-danger")
                .css("height","fit-content")
                .text(value["count"])
            )
          $("#append_user_chat").append(div);
        });
    });
  }

  //2)apro la conversazione con l'utente di interesse
  $(document).ready(function(e){
    $(document).on("click", ".open_chat", function(e){
      var id_room=$(this).attr("id_room");
      open_chat(id_room);
    });
  });

  //2.1)apro la conversazione con l'utente di interesse
  function open_chat(id_room){
    append_header_user_chat(id_room);
    $.get('/get_chat_bookmap', {id_room:id_room}, 
    function (data){
      $("#append_chat").empty();
      var res=jQuery.parseJSON(data);
      var id_user=res[res.length-1].id_user;
      $.each(res, function(key, value) {
        var id_user_send=value['id_user_send'];
        var message=value['message'];
        var balon="balon1";
        var float="float-right";
        if (key != res.length - 1) {
          if (id_user_send!=id_user) {
            balon="balon2";
            float="float-left sohbet2";
          }
          var div=$("<div>")
              .addClass(""+balon+" p-2 m-0 position-relative")
              .attr("data-is","You - 3:20 pm")
              .append(
                $("<a>")
                  .addClass(float)
                  .text(message)
              )
          $("#append_chat").append(div);
          }
      });
      get_user_bookmap();
    });  
  }

  //2.2)appendo l'utente nell'header della chat
  function append_header_user_chat(id_room){
    //prima mostro l'header e il footer
    $("#header_user_chat").removeClass("d-none");
    $("#footer_user_chat").removeClass("d-none");
    //poi mostro l'utente nell'header
    $("#header_user_chat").empty();
    var image_user=$(".open_chat[id_room="+id_room+"]").find("img").attr("src");
    var name_user=$(".open_chat[id_room="+id_room+"]").find("h6").text();
    var img=$("<img>")
          .addClass("rounded float-left")
          .css({"width": "50px", "height": "50px"})
          .attr("src",image_user);
    var h6=$("<h6>")
        .addClass("float-left")
        .css({"margin": "0px", "margin-left": "10px"})
        .text(name_user);
    $("#header_user_chat").append(img);
    $("#header_user_chat").append(h6);
    //poi nel bottone di invio messaggio mostro l'id_room
    $("#send_chat_message_from_input").attr("id_room",id_room);
    $("#send_chat_message_from_button").attr("id_room",id_room);
  }

  //puoi inviare direttamente cliccando sul bottone invio
  $(document).ready(function(){
    $("#send_chat_message_from_input").on("keypress", function(event){
      if(event.keyCode === 13){
        var id_room=$(this).attr("id_room");
        send_chat_bookmap(id_room,"","","contact");
      }
    });
  });

  //puoi invire direttamente con clik
  $(document).ready(function(){
    $("#send_chat_message_from_button").on("click", function(event){
      var id_room=$(this).attr("id_room");
      send_chat_bookmap(id_room,"","","contact");
    });
  });

  //3)invio messaggio nella conversazione
  function send_chat_bookmap(id_room, id_user_receive, idprod, from){
    var message=$(".chatSend[from="+from+"]").val();
    $.get('/send_chat_bookmap', {id_room:id_room, message:message, id_user_receive:id_user_receive, idprod:idprod}, 
    function (data){
      var idroom=jQuery.parseJSON(data);
      change_vis('contact');
      open_chat(idroom);
    });
  }

</script>
