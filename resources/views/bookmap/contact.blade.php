<style type="text/css">
 

  #contact a {
    text-decoration: none !important;
  }
		
  #contact label {
    color: rgba(120, 144, 156,1.0) !important;
  }
		
	#contact .btn:focus, .btn:active:focus, .btn.active:focus {
			outline: none !important;
			box-shadow: 0 0px 0px rgba(120, 144, 156,1.0) inset, 0 0 0px rgba(120, 144, 156,0.8);
  }

  #contact textarea:focus,
		input[type="text"]:focus,
		input[type="password"]:focus,
		input[type="datetime"]:focus,
		input[type="datetime-local"]:focus,
		input[type="date"]:focus,
		input[type="month"]:focus,
		input[type="time"]:focus,
		input[type="week"]:focus,
		input[type="number"]:focus,
		input[type="email"]:focus,
		input[type="url"]:focus,
		input[type="search"]:focus,
		input[type="tel"]:focus,
		input[type="color"]:focus,
		.uneditable-input:focus {   
		border-color: rgba(120, 144, 156,1.0); color: rgba(120, 144, 156,1.0); opacity: 0.9;
		box-shadow: 0 0px 0px rgba(120, 144, 156,1.0) inset, 0 0 10px rgba(120, 144, 156,0.3);
		outline: 0 none;
  }

  #contact.card::-webkit-scrollbar {
    width: 1px;
  }
 
  #contact::-webkit-scrollbar-thumb {
    border-radius: 9px;
	  background: rgba(96, 125, 139,0.99);
  }

  #contact .balon1, .balon2 {
	  margin-top: 5px !important;
	  margin-bottom: 5px !important;
	}

  #contact .balon1 a {
    background: #42a5f5;
    color: #fff !important;
    border-radius: 20px 20px 3px 20px;
    display: block;
    max-width: 75%;
    padding: 7px 13px 7px 13px;
	}

  #contact .balon1:before {
    content: attr(data-is);
    position: absolute;
    right: 15px;
    bottom: -0.8em;
    display: block;
    font-size: .750rem;
    color: rgba(84, 110, 122,1.0);
	}

  #contact .balon2 a {
    background: #f1f1f1;
    color: #000 !important;
    border-radius: 20px 20px 20px 3px;
    display: block;
    max-width: 75%;
    padding: 7px 13px 7px 13px;
	}
	
  #contact .balon2:before {
    content: attr(data-is);
    position: absolute;
    left: 13px;
    bottom: -0.8em;
    display: block;
    font-size: .750rem;
    color: rgba(84, 110, 122,1.0);
	}
	
  #contact .bg-sohbet:before {
    content: "";
    background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTAgOCkiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+PGNpcmNsZSBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIgY3g9IjE3NiIgY3k9IjEyIiByPSI0Ii8+PHBhdGggZD0iTTIwLjUuNWwyMyAxMW0tMjkgODRsLTMuNzkgMTAuMzc3TTI3LjAzNyAxMzEuNGw1Ljg5OCAyLjIwMy0zLjQ2IDUuOTQ3IDYuMDcyIDIuMzkyLTMuOTMzIDUuNzU4bTEyOC43MzMgMzUuMzdsLjY5My05LjMxNiAxMC4yOTIuMDUyLjQxNi05LjIyMiA5LjI3NC4zMzJNLjUgNDguNXM2LjEzMSA2LjQxMyA2Ljg0NyAxNC44MDVjLjcxNSA4LjM5My0yLjUyIDE0LjgwNi0yLjUyIDE0LjgwNk0xMjQuNTU1IDkwcy03LjQ0NCAwLTEzLjY3IDYuMTkyYy02LjIyNyA2LjE5Mi00LjgzOCAxMi4wMTItNC44MzggMTIuMDEybTIuMjQgNjguNjI2cy00LjAyNi05LjAyNS0xOC4xNDUtOS4wMjUtMTguMTQ1IDUuNy0xOC4xNDUgNS43IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PHBhdGggZD0iTTg1LjcxNiAzNi4xNDZsNS4yNDMtOS41MjFoMTEuMDkzbDUuNDE2IDkuNTIxLTUuNDEgOS4xODVIOTAuOTUzbC01LjIzNy05LjE4NXptNjMuOTA5IDE1LjQ3OWgxMC43NXYxMC43NWgtMTAuNzV6IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIvPjxjaXJjbGUgZmlsbD0iIzAwMCIgY3g9IjcxLjUiIGN5PSI3LjUiIHI9IjEuNSIvPjxjaXJjbGUgZmlsbD0iIzAwMCIgY3g9IjE3MC41IiBjeT0iOTUuNSIgcj0iMS41Ii8+PGNpcmNsZSBmaWxsPSIjMDAwIiBjeD0iODEuNSIgY3k9IjEzNC41IiByPSIxLjUiLz48Y2lyY2xlIGZpbGw9IiMwMDAiIGN4PSIxMy41IiBjeT0iMjMuNSIgcj0iMS41Ii8+PHBhdGggZmlsbD0iIzAwMCIgZD0iTTkzIDcxaDN2M2gtM3ptMzMgODRoM3YzaC0zem0tODUgMThoM3YzaC0zeiIvPjxwYXRoIGQ9Ik0zOS4zODQgNTEuMTIybDUuNzU4LTQuNDU0IDYuNDUzIDQuMjA1LTIuMjk0IDcuMzYzaC03Ljc5bC0yLjEyNy03LjExNHpNMTMwLjE5NSA0LjAzbDEzLjgzIDUuMDYyLTEwLjA5IDcuMDQ4LTMuNzQtMTIuMTF6bS04MyA5NWwxNC44MyA1LjQyOS0xMC44MiA3LjU1Ny00LjAxLTEyLjk4N3pNNS4yMTMgMTYxLjQ5NWwxMS4zMjggMjAuODk3TDIuMjY1IDE4MGwyLjk0OC0xOC41MDV6IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS4yNSIvPjxwYXRoIGQ9Ik0xNDkuMDUgMTI3LjQ2OHMtLjUxIDIuMTgzLjk5NSAzLjM2NmMxLjU2IDEuMjI2IDguNjQyLTEuODk1IDMuOTY3LTcuNzg1LTIuMzY3LTIuNDc3LTYuNS0zLjIyNi05LjMzIDAtNS4yMDggNS45MzYgMCAxNy41MSAxMS42MSAxMy43MyAxMi40NTgtNi4yNTcgNS42MzMtMjEuNjU2LTUuMDczLTIyLjY1NC02LjYwMi0uNjA2LTE0LjA0MyAxLjc1Ni0xNi4xNTcgMTAuMjY4LTEuNzE4IDYuOTIgMS41ODQgMTcuMzg3IDEyLjQ1IDIwLjQ3NiAxMC44NjYgMy4wOSAxOS4zMzEtNC4zMSAxOS4zMzEtNC4zMSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEuMjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvZz48L3N2Zz4=');
    opacity: 0.06;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    height:100%;
    position: absolute;   
	}

</style>

<div id="contact_container" class="tab-content col-md-12 p-0" style="flex: 1; position: absolute; right: 0; bottom: 0; left: 0;">  
  <div class="row h-100 m-0 p-0">
    <div class="col-3 p-0 m-0 card border-0 rounded" style="box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.10), 0 6px 10px 0 rgba(0, 0, 0, 0.01); overflow: hidden;">
      <div class="card-header p-1 bg-light border border-top-0 border-left-0 border-right-0" style="color: rgba(96, 125, 139,1.0);">
        <form class="m-0 p-0" action="" method="POST" autocomplete="off">
          <div class="row m-0 p-0">
            <div class="col-12 m-0 p-1">
              <input id="text" class="mw-100 border rounded form-control" type="text" name="text" title="Type a message..." placeholder="Type a message..." required>
            </div>
          </div>
        </form>
      </div>
      <div class="card card-body border-0 m-0 p-0" style="overflow-y: auto; height: 0;">
          <div class="d-flex flex-nowrap border-0 pt-3 px-3">
            <img class="rounded" style="width: 50px; height: 50px;" src="https://i.pinimg.com/736x/5c/24/69/5c24695df36eee73abfbdd8274085ecd--cute-anime-guys-anime-boys.jpg" />
            <h6 class="" style="margin: 0px; margin-left: 10px;"> Yusuf Bulgurcu <i class="fa fa-check text-primary" title="Onaylanmış Hesap!" aria-hidden="true"></i> </br><small> İstanbul, TR </small></h6>
          </div>
          <div class="d-flex flex-nowrap border-0 pt-3 px-3">
            <img class="rounded" style="width: 50px; height: 50px;" src="https://i.pinimg.com/736x/5c/24/69/5c24695df36eee73abfbdd8274085ecd--cute-anime-guys-anime-boys.jpg" />
            <h6 class="" style="margin: 0px; margin-left: 10px;"> Yusuf Bulgurcu <i class="fa fa-check text-primary" title="Onaylanmış Hesap!" aria-hidden="true"></i> </br><small> İstanbul, TR </small></h6>
          </div>    
      </div>
    </div>
    <div class="col-9 p-0 m-0 card border-0 rounded" style="box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.10), 0 6px 10px 0 rgba(0, 0, 0, 0.01); overflow: hidden;">
      <div class="card-header p-1 bg-light border border-top-0 border-left-0 border-right-0" style="color: rgba(96, 125, 139,1.0);">
        <img class="rounded float-left" style="width: 50px; height: 50px;" src="https://i.pinimg.com/736x/5c/24/69/5c24695df36eee73abfbdd8274085ecd--cute-anime-guys-anime-boys.jpg" />
        <h6 class="float-left" style="margin: 0px; margin-left: 10px;"> Yusuf Bulgurcu <i class="fa fa-check text-primary" title="Onaylanmış Hesap!" aria-hidden="true"></i> </br><small> İstanbul, TR </small></h6>
      </div>
      <div class="card card-body bg-sohbet border-0 m-0 p-0" style="overflow-y: auto; height: 0;">
          <div class="balon1 p-2 m-0 position-relative" data-is="You - 3:20 pm">
            <a class="float-right"> Hey there! What's up? </a>
          </div>
          <div class="balon2 p-2 m-0 position-relative" data-is="Yusuf - 3:22 pm">
            <a class="float-left sohbet2"> Checking out iOS7 you know.. </a>
          </div>
          <div class="balon1 p-2 m-0 position-relative" data-is="You - 3:23 pm">
            <a class="float-right"> Check out this bubble! </a>
          </div>
          <div class="balon2 p-2 m-0 position-relative" data-is="Yusuf - 3:26 pm">
            <a class="float-left sohbet2"> It's pretty cool! </a>
          </div>
          <div class="balon1 p-2 m-0 position-relative" data-is="You - 3:28 pm">
            <a class="float-right"> Yeah it's pure CSS & HTML </a>
          </div>
          <div class="balon2 p-2 m-0 position-relative" data-is="Yusuf - 3:33 pm">
            <a class="float-left sohbet2"> Wow that's impressive. But what's even more impressive is that this bubble is really high. </a>
          </div>
          <div class="balon1 p-2 m-0 position-relative" data-is="You - 3:28 pm">
            <a class="float-right"> Yeah it's pure CSS & HTML </a>
          </div>
          <div class="balon2 p-2 m-0 position-relative" data-is="Yusuf - 3:33 pm">
            <a class="float-left sohbet2"> Wow that's impressive. But what's even more impressive is that this bubble is really high. </a>
          </div>
          <div class="balon1 p-2 m-0 position-relative" data-is="You - 3:28 pm">
            <a class="float-right"> Yeah it's pure CSS & HTML </a>
          </div>
          <div class="balon2 p-2 m-0 position-relative" data-is="Yusuf - 3:33 pm">
            <a class="float-left sohbet2"> Wow that's impressive. But what's even more impressive is that this bubble is really high. </a>
          </div>
          <div class="balon1 p-2 m-0 position-relative" data-is="You - 3:28 pm">
            <a class="float-right"> Yeah it's pure CSS & HTML </a>
          </div>
          <div class="balon2 p-2 m-0 position-relative" data-is="Yusuf - 3:33 pm">
            <a class="float-left sohbet2"> Wow that's impressive. But what's even more impressive is that this bubble is really high. </a>
          </div>
      </div>
      <div class="w-100 card-footer p-0 bg-light border border-bottom-0 border-left-0 border-right-0">
        <form class="m-0 p-0" action="" method="POST" autocomplete="off">
          <div class="row m-0 p-0">
            <div class="col-10 m-0 p-1">
              <input id="text" class="mw-100 border rounded form-control" type="text" name="text" title="Type a message..." placeholder="Type a message..." required>
            </div>
            <div class="col-2 m-0 p-1">
              <button class="btn btn-outline-secondary rounded border w-100" title="Gönder!" style="padding-right: 16px;"><i class="bx bx-send icon-single" aria-hidden="true"></i></button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">

   //apre connessione socket con condivisione dati
    var connection = new RTCMultiConnection();
    connection.socketURL = 'https://muazkhan.com:9001/';
    connection.session = {
      data: true
    };
  
  function start_function_contact(){

    height_position();
    get_user_bookmap();

  }

  function height_position(){

    var height_page=$(window).height();
    var height_inbox_chat=height_page-78-70;
    var height_msg_history=height_page-78-70-15-48-15;

    $("#container_contact .inbox_chat").css("height",height_inbox_chat+"px");
    $("#container_contact .msg_history").css("height",height_msg_history+"px");

  }


  function get_user_bookmap(from){
    $("#append_list_user_chat_box").empty();
    $.get('/get_user_chat_box_bookmap', {}, 
      function (data){
       var res=jQuery.parseJSON(data);

     var arr1=res.get_user;
     var arr2=res.count_message;

     console.log(res)

      if (arr1==undefined && arr2==undefined) {

        window.location.replace("/bookmap");
        
      }else{

        const map = new Map();
        arr1.forEach(item => map.set(item.id_room, item));
        arr2.forEach(item => map.set(item.id_room, {...map.get(item.id_room), ...item}));
        const arr_list_user = Array.from(map.values());

        var active_chat;
        var src;
        var count_message;

        for (var i = 0; i < arr_list_user.length; i++) {

          if (i==0) {
            active_chat="active_chat";
          }else{
            active_chat="";
          }

          if (arr_list_user[i].image_user_send=="") {

            src="bookmap_repo/default_img.png?refresh=<?php echo rand(1,999); ?>"
          }else{
            src="bookmap_repo/img_profile/"+arr_list_user[i].image_user_send+"?refresh=<?php echo rand(1,999); ?>";

          }

          if (arr_list_user[i].count_message==undefined) {
            count_message=0;
          }else{
            count_message=arr_list_user[i].count_message;
          }



          $("#append_list_user_chat_box").append(
            '<div class="chat_list_contact '+active_chat+' list_user_box" onclick="open_chat(\''+arr_list_user[i].id_room+'\', \''+arr_list_user[i].id_user+'\', \''+arr_list_user[i].name_user+'\', \''+arr_list_user[i].image_user_send+'\')" id="'+arr_list_user[i].id_user+'">'+
            '<div class="chat_people">'+
            '<div class="chat_img">'+
            '<img src='+src+' alt="sunil">'+
            '</div>'+
            '<div class="chat_ib">'+
            '<h6>'+arr_list_user[i].name_user+'</h6>'+
            '</div>'+
            '<span class="badge badge_notify badge_'+arr_list_user[i].id_user+'">'+count_message+'</span>'+
            '</div>'+
            '</div>');

        }

        //detect mobile device
          if(window.matchMedia("(max-width: 767px)").matches){
               
          } else{

              open_chat(arr_list_user[0].id_room, arr_list_user[0].id_user, arr_list_user[0].name_user, arr_list_user[0].image_user_send);

          }  

        // if (from==undefined) {

        //   open_chat(arr_list_user[0].id_room, arr_list_user[0].id_user, arr_list_user[0].name_user, arr_list_user[0].image_user_send);

        // }

        var search = document.getElementById("search_input");
        var els = document.querySelectorAll(".chat_list_contact");

        search.addEventListener("keyup", function() {
          Array.prototype.forEach.call(els, function(el) {
            if (el.textContent.toLowerCase().trim().indexOf(search.value) > -1){
              el.style.display = '';
            }else{ 
              el.style.display = 'none';
            }
          });

        });

      }

    });

  }

function contact_seller(id_user_receive, name_user_receive, image_user_receive){

  open_menu(5);
  $("#name_form_contact").text("@lang('bookmap/lang.contact_seller') "+name_user_receive);
  $("#fab_send").attr("onclick","send_chat_bookmap(\""+id_user_receive+"\",\""+name_user_receive+"\",\"contact_seller\",\""+image_user_receive+"\")");

}

function send_chat_bookmap(id_user_receive, name_user_receive, from, image_user_receive){

  var id_user="@if( auth()->guard('users_bookmap')->check() ){{ auth()->guard('users_bookmap')->user()->id}}@endif";
  console.log(id_user)
  if (id_user=="") {

    open_menu(1);

  } else{

    var message;

    if (from=="contact_seller") {

      message=$("#chatSend").val();

    }else{

      message=$(".write_msg").val();

    }

    if (message!="") {

     $.get('/send_chat_bookmap', {id_user_receive:id_user_receive, name_user_receive:name_user_receive, message:message, image_user_receive:image_user_receive}, 
      function (data){
       var res=jQuery.parseJSON(data);

       var dt = new Date();
       var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();

       $(".msg_history").append(
        "<div class='outgoing_msg'>"+
        "<div class='sent_msg'>"+
        "<p>"+$(".write_msg").val()+"</p>"+
        "<span class='time_date'>"+time+"</span>"+
        "</div>");  

       if (from!="contact_seller") {

        connection.send($(".write_msg").val());
        get_user_bookmap("send_msg_socket");

      }else{
        change_vis('contact')
      }
      $(".write_msg").val("");
      $('.msg_history').scrollTop($('.msg_history')[0].scrollHeight);

    });

   }
   
 }

}  


 function open_chat(id_room, id_user_receive, name_user_receive, image_user_receive){
  connection.closeSocket();
  connection.openOrJoin(id_room);
  $("#logo_loading").addClass("rotate_logo_loading");

  $(".notify_chat").css("color","black");
  $(".badge_"+id_user_receive).text(0);
  $(".badge_"+id_user_receive).addClass("userid_"+connection.userid);
  $(".msg_history").empty();
  $(".list_user_box").removeClass("active_chat");
  $("#"+id_user_receive).addClass('active_chat');
  $(".nickname_user_chat").text(name_user_receive);
  $(".msg_send_btn").attr("onclick","send_chat_bookmap(\""+id_user_receive+"\",\""+name_user_receive+"\",\""+image_user_receive+"\")");
  if (image_user_receive=="") {
    $(".img_user_chat").attr("src","bookmap_repo/default_img.png?refresh=<?php echo rand(1,999); ?>");
  }else{
    $(".img_user_chat").attr("src","bookmap_repo/img_profile/"+image_user_receive+"?refresh=<?php echo rand(1,999); ?>");
  }


  if(window.matchMedia("(max-width: 767px)").matches){
        // The viewport is less than 768 pixels wide
        $(".inbox_people").hide();
        $(".mesgs").show();
        $(".nickname_after_return").show();
        $(".nickname_after_return").html('<div style="position: absolute;flex-grow: 1;right: 15px;"><i class="bx bx-arrow-back" onclick="back_inbox_people()"></i></div>');

      } 

      $.get('/get_chat_bookmap', {id_room:id_room}, 
        function (data){
         var res=jQuery.parseJSON(data);
         var id_user="@if( auth()->guard('users_bookmap')->check() ){{ auth()->guard('users_bookmap')->user()->id }}@endif";
         var src;
         for (var i = 0; i < res.length; i++) {

          if (res[i].image_user_send=="") {

            src="bookmap_repo/default_img.png?refresh=<?php echo rand(1,999); ?>"
          }else{
            src="bookmap_repo/img_profile/"+res[i].image_user_send+"?refresh=<?php echo rand(1,999); ?>";

          }

          if (res[i].id_user_send==id_user) {

           $(".msg_history").append(
            '<div class="outgoing_msg">'+
              '<div class="sent_msg">'+
                '<p>'+res[i].message+'</p>'+
                '<span class="time_date">'+res[i].date+'</span>'+
              '</div>'+
            '</div>');

         }else{

          $(".msg_history").append(
            '<div class="incoming_msg">'+
              // '<div class="incoming_msg_img"> <img src="'+src+'" alt="sunil">'+
              '</div>'+
              '<div class="received_msg">'+
                '<div class="received_withd_msg">'+
                  '<p>'+res[i].message+'</p>'+
                  '<span class="time_date">'+res[i].date+'</span>'+
                '</div>'+
              '</div>'+
            '</div>');

        }

      }

      $('.msg_history').scrollTop($('.msg_history')[0].scrollHeight);
      $("#logo_loading").removeClass("rotate_logo_loading");

    });  

    }

function back_inbox_people(){

  if(window.matchMedia("(max-width: 767px)").matches){
        // The viewport is less than 768 pixels wide
        $(".inbox_people").show();
        $(".mesgs").hide();
        $(".nickname_after_return").hide();
  
    } 

}


//riceve i messaggi
connection.onmessage = function(event) {
  var dt = new Date();
  var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();

   get_user_bookmap("receive_msg_socket");
   $(".notify_chat").css("color","red");

  $(".msg_history").append("<div class='incoming_msg'>"+
    "<div class='received_msg'>"+
    "<div class='received_withd_msg'>"+
    "<p>"+event.data+"</p>"+
    "<span class='time_date'>"+time+"</span>"+
    "</div>"+
    "</div>"+
    "</div>");

  $('.msg_history').scrollTop($('.msg_history')[0].scrollHeight);

};


</script>
